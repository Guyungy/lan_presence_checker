<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å†å²çƒ­åŠ›å›¾ï¼ˆåˆ†é’Ÿçº§ï¼‰ - {{ ip }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 1.5rem; }
    #chart { width: 100%; height: 600px; }
    .btn-group .btn { min-width: 60px; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">ğŸ“Š è®¾å¤‡å†å²çƒ­åŠ›å›¾ï¼ˆåˆ†é’Ÿçº§ï¼‰ - {{ ip }}</h1>
    <div class="mb-3">
      <a class="btn btn-secondary me-2" href="/">â† è¿”å›</a>
      <div class="btn-group" role="group">
        <button class="btn btn-outline-primary" onclick="render('daily')">æ—¥</button>
        <button class="btn btn-outline-primary" onclick="render('weekly')">å‘¨</button>
        <button class="btn btn-outline-primary" onclick="render('monthly')">æœˆ</button>
      </div>
    </div>
    <div id="chart"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <script>
    const ip = "{{ ip }}";
    const chart = echarts.init(document.getElementById('chart'));

    function getDateLabels(period) {
      const now = new Date(), dates = [];
      if (period === 'daily') {
        dates.push(now);
      } else if (period === 'weekly') {
        for (let i = 6; i >= 0; i--) {
          const d = new Date(now);
          d.setDate(d.getDate() - i);
          dates.push(d);
        }
      } else {
        for (let i = 29; i >= 0; i--) {
          const d = new Date(now);
          d.setDate(d.getDate() - i);
          dates.push(d);
        }
      }
      return dates.map(d => d.toISOString().slice(0,10));
    }

    async function render(period) {
      const dates = getDateLabels(period);
      const resp  = await fetch(`/api/history/${ip}?period=${period}`);
      const data  = await resp.json();

      // ç”Ÿæˆ [dayIndex, minuteOfDay, 1] æ•°æ®
      const points = data
        .filter(e => e.online)
        .map(e => {
          const [date, time] = e.timestamp.split(' ');
          const dayIdx = dates.indexOf(date);
          if (dayIdx < 0) return;
          const [hh, mm] = time.split(':');
          const minuteOfDay = +hh * 60 + +mm; // 0â€“1439
          return [dayIdx, minuteOfDay, 1];
        })
        .filter(Boolean);

      chart.setOption({
        tooltip: {
          formatter: params => {
            const date = dates[params.value[0]];
            const m    = params.value[1];
            const hh   = Math.floor(m/60).toString().padStart(2,'0');
            const mm   = (m%60).toString().padStart(2,'0');
            return `${date} ${hh}:${mm} â€“ åœ¨çº¿`;
          }
        },
        grid: { left:'10%', right:'10%', bottom:'15%', containLabel:true },
        xAxis: {
          type: 'category',
          data: dates,
          boundaryGap: false,
          axisLabel: { rotate: 45 }
        },
        yAxis: {
          type: 'value',
          min: 0,
          max: 1440,
          interval: 120,
          axisLabel: {
            formatter: val => {
              const hh = Math.floor(val/60).toString().padStart(2,'0');
              return `${hh}:00`;
            }
          },
          inverse: true
        },
        visualMap: {
          show: false,
          min: 0,
          max: 1,
          inRange: { color: ['#ffffff', '#3398DB'] }
        },
        series: [{
          name: 'åœ¨çº¿çƒ­åŠ›',
          type: 'heatmap',
          data: points,
          pointSize: 1,
          blurSize: 0
        }]
      });
    }

    // é»˜è®¤åŠ è½½
    render('daily');
  </script>
</body>
</html>
