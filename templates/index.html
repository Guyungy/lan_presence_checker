<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>è€ƒå‹¤äº’åŠ¨ä»ªè¡¨ç›˜</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style> body { padding: 1.5rem; } .status-chip { font-size: .9rem; } </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">ğŸ“¡ è€ƒå‹¤äº’åŠ¨ä»ªè¡¨ç›˜</h1>

  <div class="mb-3 d-flex align-items-center gap-2">
    <button class="btn btn-outline-primary" onclick="fetchStatus()">åˆ·æ–°</button>
    <button class="btn btn-outline-success" onclick="triggerScan()">æ‰‹åŠ¨æ‰«æ</button>

    <!-- è®¾å¤‡ç±»å‹è¿‡æ»¤ -->
    <div class="form-check form-check-inline ms-3">
      <input class="form-check-input" type="radio" name="f_type" id="f_all" value="" checked onchange="applyFilters()">
      <label class="form-check-label" for="f_all">å…¨éƒ¨</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="f_type" id="f_pc" value="ç”µè„‘" onchange="applyFilters()">
      <label class="form-check-label" for="f_pc">ç”µè„‘</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="f_type" id="f_phone" value="æ‰‹æœº" onchange="applyFilters()">
      <label class="form-check-label" for="f_phone">æ‰‹æœº</label>
    </div>

    <input
      id="search"
      class="form-control w-25 ms-auto"
      type="search"
      placeholder="æœç´¢ IP/åç§°"
      oninput="applyFilters()"
    >
    <span id="status" class="ms-2 text-muted">åŠ è½½ä¸­â€¦</span>
  </div>

  <table class="table table-hover">
    <thead class="table-light">
      <tr>
        <th>çŠ¶æ€</th><th>å§“å</th><th>ç±»å‹</th><th>IP</th>
        <th>æœ€ååœ¨çº¿</th><th>æ—¶é•¿</th><th>å¤‡æ³¨</th>
      </tr>
    </thead>
    <tbody id="body">
      <tr><td colspan="7">æš‚æ— æ•°æ®</td></tr>
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentData = {};

// å°†æ‰€æœ‰è¡Œæ ‡è®°ä¸ºâ€œæŸ¥è¯¢ä¸­â€
function markQuerying(){
  document.querySelectorAll("#body tr").forEach(row=>{
    const cell = row.querySelector(".status-chip");
    if(cell) {
      cell.className = "badge bg-warning status-chip";
      cell.innerText = "æŸ¥è¯¢ä¸­";
    }
  });
}

async function fetchStatus(){
  document.getElementById("status").innerText = "åˆ·æ–°ä¸­â€¦";
  try{
    const res = await fetch("/api/status");
    currentData = await res.json();
    renderTable(currentData);
    applyFilters();
  }catch(e){
    document.getElementById("status").innerText = "åŠ è½½å¤±è´¥";
  }
}

async function triggerScan(){
  markQuerying();
  document.getElementById("status").innerText = "æ‰«æä¸­â€¦";
  try{
    const res = await fetch("/api/scan",{method:"POST"});
    currentData = await res.json();
    renderTable(currentData);
    applyFilters();
  }catch(e){
    document.getElementById("status").innerText = "æ‰«æå¤±è´¥";
  }
}

async function updateDevice(ip, field, value){
  await fetch("/api/device",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ip, [field]:value})
  });
}

function renderTable({online, offline, now}){
  document.getElementById("status").innerText = `æœ€åæ›´æ–°ï¼š${now}`;
  const body = document.getElementById("body");
  body.innerHTML = "";
  // åœ¨çº¿è¡Œ
  for(let ip in online){
    const info = online[ip];
    body.insertAdjacentHTML("beforeend", `
      <tr data-type="${info.type}">
        <td>
          <span class="badge bg-primary status-chip">åœ¨çº¿</span>
        </td>
        <td><a href="/device/${ip}">${info.name}</a></td>
        <td><input class="form-control form-control-sm" value="${info.type}"
                   onchange="updateDevice('${ip}','type',this.value)" /></td>
        <td>${ip}</td>
        <td>${info.last_seen}</td>
        <td>${info.duration}</td>
        <td><input class="form-control form-control-sm"
                   value="${info.remark||''}"
                   onchange="updateDevice('${ip}','remark',this.value)" /></td>
      </tr>`);
  }
  // ç¦»çº¿è¡Œ
  for(let ip in offline){
    const info = offline[ip];
    body.insertAdjacentHTML("beforeend", `
      <tr data-type="${info.type}">
        <td>
          <span class="badge bg-danger status-chip">ç¦»çº¿</span>
        </td>
        <td><a href="/device/${ip}">${info.name}</a></td>
        <td><input class="form-control form-control-sm" value="${info.type}"
                   onchange="updateDevice('${ip}','type',this.value)" /></td>
        <td>${ip}</td>
        <td>â€”</td>
        <td>â€”</td>
        <td><input class="form-control form-control-sm"
                   value="${info.remark||''}"
                   onchange="updateDevice('${ip}','remark',this.value)" /></td>
      </tr>`);
  }
  if(!Object.keys(online).length && !Object.keys(offline).length){
    body.innerHTML = `<tr><td colspan="7" class="text-center">æš‚æ— è®¾å¤‡</td></tr>`;
  }
}

function applyFilters(){
  const kw = document.getElementById("search").value.toLowerCase();
  const type = document.querySelector('input[name="f_type"]:checked').value;
  document.querySelectorAll("#body tr").forEach(row=>{
    const txt = row.textContent.toLowerCase();
    const dtype = row.getAttribute("data-type");
    const okText = !kw || txt.includes(kw);
    const okType = !type || dtype===type;
    row.style.display = okText && okType ? "" : "none";
  });
}

// åˆå§‹åŒ–
fetchStatus();
setInterval(fetchStatus, 10000);
</script>
</body>
</html>
