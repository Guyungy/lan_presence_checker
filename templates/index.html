<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>考勤互动仪表盘</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      padding: 1.5rem; 
      background-color: #f8f9fa;
    }
    .status-chip { 
      font-size: .9rem; 
      padding: 0.25rem 0.5rem;
      border-radius: 50rem;
    }
    .card {
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .card-header {
      border-radius: 10px 10px 0 0 !important;
      font-weight: 600;
    }
    .stats-card {
      text-align: center;
      padding: 1rem;
    }
    .stats-value {
      font-size: 2rem;
      font-weight: 700;
      margin: 0.5rem 0;
    }
    .stats-label {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .table-hover tbody tr:hover {
      background-color: rgba(0, 123, 255, 0.05);
    }
    .device-name {
      font-weight: 600;
    }
    .device-offline {
      opacity: 0.7;
    }
    .refresh-btn {
      position: relative;
    }
    .refresh-btn.spinning i {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spin {
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    .type-badge {
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      background-color: #e9ecef;
      color: #495057;
      display: inline-block;
    }
    .last-check-warning {
      color: #ffc107;
    }
    .last-check-danger {
      color: #dc3545;
    }
    .chart-container {
      position: relative;
      height: 200px;
      width: 100%;
    }
    /* 网段卡片样式 */
    .network-card {
      transition: all 0.3s ease;
    }
    .network-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    .network-card .card-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    /* 设备详情模态框样式 */
    .device-detail-table th {
      width: 120px;
    }
    /* 按钮组样式 */
    .btn-group-sm .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-broadcast"></i> 考勤互动仪表盘</h1>
    <div>
      <button id="refreshBtn" class="btn btn-primary refresh-btn" onclick="fetchStatus()">
        <i class="bi bi-arrow-clockwise"></i> 刷新
      </button>
      <button id="scanBtn" class="btn btn-success" onclick="triggerScan()">
        <i class="bi bi-search"></i> 手动扫描
      </button>
    </div>
  </div>

  <!-- 统计卡片 -->
  <div class="row mb-4" id="stats-cards">
    <div class="col-md-3">
      <div class="card stats-card">
        <div class="stats-label">总设备数</div>
        <div class="stats-value" id="total-devices">-</div>
        <div class="progress" style="height: 5px;">
          <div class="progress-bar bg-primary" style="width: 100%"></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card">
        <div class="stats-label">在线设备</div>
        <div class="stats-value text-success" id="online-devices">-</div>
        <div class="progress" style="height: 5px;">
          <div class="progress-bar bg-success" id="online-progress" style="width: 0%"></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card">
        <div class="stats-label">离线设备</div>
        <div class="stats-value text-danger" id="offline-devices">-</div>
        <div class="progress" style="height: 5px;">
          <div class="progress-bar bg-danger" id="offline-progress" style="width: 0%"></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card">
        <div class="stats-label">在线率</div>
        <div class="stats-value text-primary" id="online-rate">-</div>
        <div class="progress" style="height: 5px;">
          <div class="progress-bar bg-info" id="rate-progress" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 网段信息 -->
  <div class="card mb-4" id="networks-card">
    <div class="card-header bg-light">网段信息</div>
    <div class="card-body" id="networks-container">
      <div class="d-flex justify-content-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">加载中...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 图表 -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">设备类型分布</div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="typeChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">在线状态趋势</div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 过滤器 -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="d-flex align-items-center">
            <label class="me-2">设备类型:</label>
            <div class="btn-group" role="group" id="type-filter">
              <input type="radio" class="btn-check" name="f_type" id="f_all" value="" checked onchange="applyFilters()">
              <label class="btn btn-outline-primary btn-sm" for="f_all">全部</label>
              
              <input type="radio" class="btn-check" name="f_type" id="f_pc" value="电脑" onchange="applyFilters()">
              <label class="btn btn-outline-primary btn-sm" for="f_pc">电脑</label>
              
              <input type="radio" class="btn-check" name="f_type" id="f_phone" value="手机" onchange="applyFilters()">
              <label class="btn btn-outline-primary btn-sm" for="f_phone">手机</label>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex align-items-center">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input
                id="search"
                class="form-control"
                type="search"
                placeholder="搜索 IP/名称/备注"
                oninput="applyFilters()"
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 状态信息 -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5>设备列表</h5>
    <span id="status" class="text-muted"><i class="bi bi-clock"></i> 加载中…</span>
  </div>

  <!-- 设备表格 -->
  <div class="card">
    <div class="card-body p-0">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>状态</th>
            <th>姓名</th>
            <th>类型</th>
            <th>IP</th>
            <th>主机名</th>
            <th>响应时间</th>
            <th>最后检测</th>
            <th>备注</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="body">
          <tr><td colspan="9" class="text-center">加载中...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- 设备详情模态框 -->
  <div class="modal fade" id="deviceModal" tabindex="-1" aria-labelledby="deviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deviceModalLabel">设备详情</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
        </div>
        <div class="modal-body" id="deviceModalBody">
          <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">加载中...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 编辑设备模态框 -->
  <div class="modal fade" id="editDeviceModal" tabindex="-1" aria-labelledby="editDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editDeviceModalLabel">编辑设备</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
        </div>
        <div class="modal-body">
          <form id="editDeviceForm">
            <input type="hidden" id="edit-ip">
            <div class="mb-3">
              <label for="edit-name" class="form-label">设备名称</label>
              <input type="text" class="form-control" id="edit-name" placeholder="输入设备名称">
            </div>
            <div class="mb-3">
              <label for="edit-type" class="form-label">设备类型</label>
              <select class="form-select" id="edit-type">
                <option value="电脑">电脑</option>
                <option value="手机">手机</option>
                <option value="平板">平板</option>
                <option value="服务器">服务器</option>
                <option value="打印机">打印机</option>
                <option value="路由器">路由器</option>
                <option value="交换机">交换机</option>
                <option value="摄像头">摄像头</option>
                <option value="智能设备">智能设备</option>
                <option value="未分类">未分类</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="edit-remark" class="form-label">备注</label>
              <textarea class="form-control" id="edit-remark" rows="3" placeholder="输入备注信息"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="saveDeviceBtn">保存</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentData = {};
let statusHistory = [];
let typeChart = null;
let statusChart = null;
let isLoading = false;

// 设置加载状态
function setLoading(loading) {
  isLoading = loading;
  const refreshBtn = document.getElementById("refreshBtn");
  const scanBtn = document.getElementById("scanBtn");
  
  if (loading) {
    refreshBtn.classList.add("spinning");
    refreshBtn.disabled = true;
    scanBtn.disabled = true;
  } else {
    refreshBtn.classList.remove("spinning");
    refreshBtn.disabled = false;
    scanBtn.disabled = false;
  }
}

// 将所有行标记为"查询中"
function markQuerying() {
  document.querySelectorAll("#body tr").forEach(row => {
    const cell = row.querySelector(".status-chip");
    if (cell) {
      cell.className = "badge bg-warning status-chip";
      cell.innerText = "查询中";
    }
  });
}

async function fetchStatus() {
  if (isLoading) return;
  
  setLoading(true);
  document.getElementById("status").innerHTML = '<i class="bi bi-arrow-repeat spin"></i> 刷新中…';
  
  try {
    const res = await fetch("/api/status");
    if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    
    currentData = await res.json();
    updateStatusHistory(currentData);
    renderDashboard(currentData);
    applyFilters();
    
    document.getElementById("status").innerHTML = 
      `<i class="bi bi-check-circle-fill text-success"></i> 最后更新：${currentData.now}`;
  } catch (e) {
    console.error("获取状态失败:", e);
    document.getElementById("status").innerHTML = 
      `<i class="bi bi-exclamation-triangle-fill text-danger"></i> 加载失败: ${e.message}`;
  } finally {
    setLoading(false);
    // 设置下一次刷新
    setTimeout(fetchStatus, 15000);
  }
}

async function triggerScan() {
  if (isLoading) return;
  
  setLoading(true);
  markQuerying();
  document.getElementById("status").innerHTML = '<i class="bi bi-search spin"></i> 扫描中…';
  
  try {
    const res = await fetch("/api/scan", { method: "POST" });
    if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    
    currentData = await res.json();
    updateStatusHistory(currentData);
    renderDashboard(currentData);
    applyFilters();
    
    document.getElementById("status").innerHTML = 
      `<i class="bi bi-check-circle-fill text-success"></i> 扫描完成：${currentData.now}`;
  } catch (e) {
    console.error("扫描失败:", e);
    document.getElementById("status").innerHTML = 
      `<i class="bi bi-exclamation-triangle-fill text-danger"></i> 扫描失败: ${e.message}`;
  } finally {
    setLoading(false);
  }
}

async function updateDevice(ip, field, value) {
  try {
    const res = await fetch("/api/device", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ip, [field]: value })
    });
    
    if (!res.ok) {
      const data = await res.json();
      throw new Error(data.error || `HTTP error ${res.status}`);
    }
    
    // 更新成功后刷新数据
    await fetchStatus();
    return true;
  } catch (e) {
    console.error("更新设备失败:", e);
    alert(`更新失败: ${e.message}`);
    return false;
  }
}

// 更新状态历史记录
function updateStatusHistory(data) {
  const timestamp = new Date();
  const onlineCount = Object.keys(data.online || {}).length;
  const offlineCount = Object.keys(data.offline || {}).length;
  const totalCount = onlineCount + offlineCount;
  
  statusHistory.push({
    timestamp,
    online: onlineCount,
    offline: offlineCount,
    total: totalCount
  });
  
  // 保留最近10个数据点
  if (statusHistory.length > 10) {
    statusHistory.shift();
  }
}

// 更新设备类型图表
function updateTypeChart(data) {
  const typeStats = data.type_stats || {};
  const types = Object.keys(typeStats);
  const onlineCounts = [];
  const offlineCounts = [];
  
  types.forEach(type => {
    onlineCounts.push(typeStats[type].online || 0);
    offlineCounts.push(typeStats[type].offline || 0);
  });
  
  const ctx = document.getElementById('typeChart').getContext('2d');
  
  if (typeChart) {
    typeChart.data.labels = types;
    typeChart.data.datasets[0].data = onlineCounts;
    typeChart.data.datasets[1].data = offlineCounts;
    typeChart.update();
  } else {
    typeChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: types,
        datasets: [
          {
            label: '在线',
            data: onlineCounts,
            backgroundColor: 'rgba(40, 167, 69, 0.7)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 1
          },
          {
            label: '离线',
            data: offlineCounts,
            backgroundColor: 'rgba(220, 53, 69, 0.7)',
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            stacked: true,
            grid: {
              display: false
            }
          },
          y: {
            stacked: true,
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        }
      }
    });
  }
}

// 更新状态趋势图表
function updateStatusChart() {
  if (statusHistory.length === 0) return;
  
  const labels = statusHistory.map(entry => {
    const date = new Date(entry.timestamp);
    return date.toLocaleTimeString();
  });
  
  const onlineData = statusHistory.map(entry => entry.online);
  const offlineData = statusHistory.map(entry => entry.offline);
  
  const ctx = document.getElementById('statusChart').getContext('2d');
  
  if (statusChart) {
    statusChart.data.labels = labels;
    statusChart.data.datasets[0].data = onlineData;
    statusChart.data.datasets[1].data = offlineData;
    statusChart.update();
  } else {
    statusChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: '在线设备',
            data: onlineData,
            borderColor: 'rgba(40, 167, 69, 1)',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            fill: true,
            tension: 0.4
          },
          {
            label: '离线设备',
            data: offlineData,
            borderColor: 'rgba(220, 53, 69, 1)',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            fill: true,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        }
      }
    });
  }
}

// 更新统计卡片
function updateStatsCards(data) {
  const onlineCount = Object.keys(data.online || {}).length;
  const offlineCount = Object.keys(data.offline || {}).length;
  const totalCount = onlineCount + offlineCount;
  const onlineRate = totalCount > 0 ? Math.round((onlineCount / totalCount) * 100) : 0;
  
  document.getElementById('total-devices').textContent = totalCount;
  document.getElementById('online-devices').textContent = onlineCount;
  document.getElementById('offline-devices').textContent = offlineCount;
  document.getElementById('online-rate').textContent = `${onlineRate}%`;
  
  // 更新进度条
  document.getElementById('online-progress').style.width = `${onlineCount / totalCount * 100}%`;
  document.getElementById('offline-progress').style.width = `${offlineCount / totalCount * 100}%`;
  document.getElementById('rate-progress').style.width = `${onlineRate}%`;
}

// 更新网段信息
function updateNetworks(data) {
  const networksContainer = document.getElementById('networks-container');
  const networks = data.networks || [];
  
  if (networks.length === 0) {
    networksContainer.innerHTML = '<div class="alert alert-info">暂无网段信息</div>';
    return;
  }
  
  let html = '<div class="row">';
  
  networks.forEach(network => {
    const onlinePercent = network.total > 0 ? Math.round((network.online / network.total) * 100) : 0;
    
    html += `
      <div class="col-md-6 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">${network.cidr}</h5>
            <p class="card-text">
              <span class="badge bg-success me-1">在线: ${network.online}</span>
              <span class="badge bg-danger me-1">离线: ${network.offline}</span>
              <span class="badge bg-info">总计: ${network.total}</span>
            </p>
            <div class="progress mb-2">
              <div class="progress-bar bg-success" role="progressbar" style="width: ${onlinePercent}%" 
                aria-valuenow="${onlinePercent}" aria-valuemin="0" aria-valuemax="100">${onlinePercent}%</div>
            </div>
            <small class="text-muted">最后扫描: ${network.last_scan || '未知'}</small>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  networksContainer.innerHTML = html;
}

// 更新设备类型过滤器
function updateTypeFilters(data) {
  const typeStats = data.type_stats || {};
  const types = Object.keys(typeStats);
  const typeFilter = document.getElementById('type-filter');
  
  // 保留"全部"选项
  const allOption = typeFilter.querySelector('#f_all').parentNode;
  typeFilter.innerHTML = '';
  typeFilter.appendChild(allOption);
  
  // 添加类型选项
  types.forEach((type, index) => {
    const count = (typeStats[type].online || 0) + (typeStats[type].offline || 0);
    const id = `f_type_${index}`;
    
    const input = document.createElement('input');
    input.type = 'radio';
    input.className = 'btn-check';
    input.name = 'f_type';
    input.id = id;
    input.value = type;
    input.onchange = applyFilters;
    
    const label = document.createElement('label');
    label.className = 'btn btn-outline-primary btn-sm';
    label.htmlFor = id;
    label.textContent = `${type} (${count})`;
    
    typeFilter.appendChild(input);
    typeFilter.appendChild(label);
  });
}

// 渲染仪表盘
function renderDashboard(data) {
  updateStatsCards(data);
  updateNetworks(data);
  updateTypeChart(data);
  updateStatusChart();
  updateTypeFilters(data);
  renderTable(data);
}

// 查看设备详情
async function viewDeviceDetails(ip) {
  const modal = new bootstrap.Modal(document.getElementById('deviceModal'));
  const modalBody = document.getElementById('deviceModalBody');
  const modalTitle = document.getElementById('deviceModalLabel');
  
  modalBody.innerHTML = `
    <div class="d-flex justify-content-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">加载中...</span>
      </div>
    </div>
  `;
  
  modal.show();
  
  try {
    // 获取设备历史记录
    const res = await fetch(`/api/history/${ip}?period=daily`);
    if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    
    const history = await res.json();
    const device = currentData.online[ip] || currentData.offline[ip] || { ip };
    
    modalTitle.textContent = `设备详情: ${device.name || '未命名设备'} (${ip})`;
    
    // 创建历史记录图表
    let historyHtml = '';
    
    if (history.length > 0) {
      historyHtml = `
        <div class="card mb-3">
          <div class="card-header">24小时在线记录</div>
          <div class="card-body">
            <div style="height: 200px;">
              <canvas id="historyChart"></canvas>
            </div>
          </div>
        </div>
      `;
    } else {
      historyHtml = `
        <div class="alert alert-info">
          暂无历史记录数据
        </div>
      `;
    }
    
    // 设备基本信息
    const statusClass = device.online ? 'success' : 'danger';
    const statusText = device.online ? '在线' : '离线';
    
    modalBody.innerHTML = `
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header">基本信息</div>
            <div class="card-body">
              <table class="table table-sm">
                <tr>
                  <th>状态:</th>
                  <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                </tr>
                <tr>
                  <th>IP地址:</th>
                  <td>${ip}</td>
                </tr>
                <tr>
                  <th>主机名:</th>
                  <td>${device.hostname || '未知'}</td>
                </tr>
                <tr>
                  <th>设备类型:</th>
                  <td>${device.type || '未分类'}</td>
                </tr>
                <tr>
                  <th>响应时间:</th>
                  <td>${device.response_time ? device.response_time + ' ms' : '未知'}</td>
                </tr>
                <tr>
                  <th>最后检测:</th>
                  <td>${device.last_seen || '未知'}</td>
                </tr>
                <tr>
                  <th>备注:</th>
                  <td>${device.remark || '无'}</td>
                </tr>
              </table>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header">操作</div>
            <div class="card-body">
              <button class="btn btn-primary mb-2 w-100" onclick="editDevice('${ip}')">编辑设备信息</button>
              <button class="btn btn-info mb-2 w-100" onclick="window.open('/api/history/${ip}?period=monthly', '_blank')">查看原始历史数据</button>
            </div>
          </div>
        </div>
      </div>
      ${historyHtml}
    `;
    
    // 如果有历史记录，创建图表
    if (history.length > 0) {
      const labels = history.map(entry => {
        const date = new Date(entry.timestamp);
        return date.toLocaleTimeString();
      });
      
      const data = history.map(entry => entry.online ? 1 : 0);
      const responseData = history.map(entry => entry.response_time || null);
      
      const ctx = document.getElementById('historyChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: '在线状态',
              data: data,
              borderColor: 'rgba(40, 167, 69, 1)',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              fill: true,
              stepped: true,
              yAxisID: 'y'
            },
            {
              label: '响应时间 (ms)',
              data: responseData,
              borderColor: 'rgba(0, 123, 255, 1)',
              backgroundColor: 'rgba(0, 123, 255, 0)',
              borderDash: [5, 5],
              pointRadius: 3,
              fill: false,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 1,
              ticks: {
                callback: function(value) {
                  return value === 1 ? '在线' : '离线';
                }
              }
            },
            y1: {
              position: 'right',
              beginAtZero: true,
              title: {
                display: true,
                text: '响应时间 (ms)'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          }
        }
      });
    }
    
  } catch (e) {
    console.error("获取设备详情失败:", e);
    modalBody.innerHTML = `
      <div class="alert alert-danger">
        获取设备详情失败: ${e.message}
      </div>
    `;
  }
}

// 编辑设备信息
function editDevice(ip) {
  const device = currentData.online[ip] || currentData.offline[ip] || { ip };
  const modal = new bootstrap.Modal(document.getElementById('editDeviceModal'));
  
  document.getElementById('edit-ip').value = ip;
  document.getElementById('edit-name').value = device.name || '';
  document.getElementById('edit-type').value = device.type || '未分类';
  document.getElementById('edit-remark').value = device.remark || '';
  
  // 保存按钮事件
  document.getElementById('saveDeviceBtn').onclick = async function() {
    const name = document.getElementById('edit-name').value;
    const type = document.getElementById('edit-type').value;
    const remark = document.getElementById('edit-remark').value;
    
    const success = await updateDevice(ip, 'name', name);
    if (success) {
      await updateDevice(ip, 'type', type);
      await updateDevice(ip, 'remark', remark);
      modal.hide();
    }
  };
  
  modal.show();
}

function renderTable({online, offline, now}) {
  const body = document.getElementById("body");
  body.innerHTML = "";
  
  // 在线行
  for (let ip in online) {
    const info = online[ip];
    const name = info.name || "未命名设备";
    const type = info.type || "未分类";
    const hostname = info.hostname || "—";
    const responseTime = info.response_time ? `${info.response_time} ms` : "—";
    const lastSeen = info.last_seen || "—";
    const remark = info.remark || "";
    
    // 创建类型徽章样式
    const typeBadge = `<span class="type-badge">${type}</span>`;
    
    body.insertAdjacentHTML("beforeend", `
      <tr data-type="${type}">
        <td>
          <span class="badge bg-success status-chip">在线</span>
        </td>
        <td class="device-name">${name}</td>
        <td>${typeBadge}</td>
        <td>${ip}</td>
        <td>${hostname}</td>
        <td>${responseTime}</td>
        <td>${lastSeen}</td>
        <td>
          <input class="form-control form-control-sm" placeholder="添加备注"
                 value="${remark}" onchange="updateDevice('${ip}','remark',this.value)" />
        </td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="viewDeviceDetails('${ip}')">
              <i class="bi bi-info-circle"></i>
            </button>
            <button class="btn btn-outline-secondary" onclick="editDevice('${ip}')">
              <i class="bi bi-pencil"></i>
            </button>
          </div>
        </td>
      </tr>
    `);
  }
  
  // 离线行
  for (let ip in offline) {
    const info = offline[ip];
    const name = info.name || "未命名设备";
    const type = info.type || "未分类";
    const hostname = info.hostname || "—";
    const lastSeen = info.last_seen || "—";
    const remark = info.remark || "";
    
    // 创建类型徽章样式
    const typeBadge = `<span class="type-badge">${type}</span>`;
    
    // 检查最后检测时间是否过久
    let lastSeenClass = "";
    if (info.last_check_minutes) {
      if (info.last_check_minutes > 60) {
        lastSeenClass = "last-check-danger";
      } else if (info.last_check_minutes > 30) {
        lastSeenClass = "last-check-warning";
      }
    }
    
    body.insertAdjacentHTML("beforeend", `
      <tr data-type="${type}" class="device-offline">
        <td>
          <span class="badge bg-danger status-chip">离线</span>
        </td>
        <td class="device-name">${name}</td>
        <td>${typeBadge}</td>
        <td>${ip}</td>
        <td>${hostname}</td>
        <td>—</td>
        <td class="${lastSeenClass}">${lastSeen}</td>
        <td>
          <input class="form-control form-control-sm" placeholder="添加备注"
                 value="${remark}" onchange="updateDevice('${ip}','remark',this.value)" />
        </td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="viewDeviceDetails('${ip}')">
              <i class="bi bi-info-circle"></i>
            </button>
            <button class="btn btn-outline-secondary" onclick="editDevice('${ip}')">
              <i class="bi bi-pencil"></i>
            </button>
          </div>
        </td>
      </tr>
    `);
  }
  
  if (!Object.keys(online).length && !Object.keys(offline).length) {
    body.innerHTML = `<tr><td colspan="9" class="text-center">暂无设备</td></tr>`;
  }
}

function applyFilters() {
  const kw = document.getElementById("search").value.toLowerCase();
  const type = document.querySelector('input[name="f_type"]:checked').value;
  let visibleCount = 0;
  
  document.querySelectorAll("#body tr").forEach(row => {
    const txt = row.textContent.toLowerCase();
    const dtype = row.getAttribute("data-type");
    const okText = !kw || txt.includes(kw);
    const okType = !type || dtype === type;
    const visible = okText && okType;
    
    row.style.display = visible ? "" : "none";
    if (visible) visibleCount++;
  });
  
  // 显示过滤结果
  const totalDevices = Object.keys(currentData.online || {}).length + Object.keys(currentData.offline || {}).length;
  if (kw || type) {
    document.getElementById("status").innerHTML += ` <span class="badge bg-info">过滤: ${visibleCount}/${totalDevices}</span>`;
  }
}

// 初始化
fetchStatus();
</script>
</body>
</html>
